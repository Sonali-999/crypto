<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediQueue Admin Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .status-waiting {
            color: #eab308;
            font-weight: 500;
        }
        .status-completed {
            color: #22c55e;
            font-weight: 500;
        }
        .badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
        }
        .badge-waiting {
            background-color: #fef3c7;
            color: #92400e;
        }
        .badge-completed {
            background-color: #d1fae5;
            color: #065f46;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            background-color: #10b981;
        }
        .notification.error {
            background-color: #ef4444;
        }
        .queue-item-completed {
            opacity: 0.7;
            background-color: #f0fdf4 !important;
        }
        .token-highlight {
            background-color: #f0f9ff;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { background-color: #f0f9ff; }
            50% { background-color: #e0f2fe; }
            100% { background-color: #f0f9ff; }
        }
        .date-filter {
            background-color: #eff6ff;
            border-radius: 6px;
            padding: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center">
                <div class="bg-blue-100 p-2 rounded-lg mr-3">
                    <i class="fas fa-clinic-medical text-blue-600 text-xl"></i>
                </div>
                <h1 class="text-xl font-bold text-gray-800">MediQueue Admin Dashboard</h1>
            </div>
            <div class="flex items-center">
                <span class="mr-4 text-gray-600">Welcome, <span id="adminUsername">admin</span></span>
                <button id="refreshBtn" class="bg-blue-500 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-600 transition duration-300 mr-3">
                    <i class="fas fa-sync-alt mr-2"></i> Refresh
                </button>
                <a href="/" class="bg-gray-500 text-white px-4 py-2 rounded-md font-semibold hover:bg-gray-600 transition duration-300 mr-3">
                    <i class="fas fa-arrow-left mr-2"></i> Back to Main
                </a>
                <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-600 transition duration-300">
                    <i class="fas fa-sign-out-alt mr-2"></i> Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Date Filter -->
        <div class="bg-white p-4 rounded-lg shadow mb-6">
            <h2 class="text-lg font-semibold mb-3">Filter by Date</h2>
            <div class="flex items-center space-x-4">
                <div class="date-filter">
                    <label for="filterDate" class="block text-sm font-medium text-gray-700 mb-1">Select Date:</label>
                    <input type="date" id="filterDate" class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <button id="todayBtn" class="bg-blue-500 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-600 transition duration-300">
                        Today
                    </button>
                </div>
                <div>
                    <button id="resetFilterBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md font-semibold hover:bg-gray-600 transition duration-300">
                        Reset Filter
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600 mr-4">
                        <i class="fas fa-users text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Total Patients</p>
                        <h3 class="text-2xl font-bold" id="totalPatients">0</h3>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600 mr-4">
                        <i class="fas fa-clock text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Waiting</p>
                        <h3 class="text-2xl font-bold" id="waitingPatients">0</h3>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600 mr-4">
                        <i class="fas fa-check-circle text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Completed</p>
                        <h3 class="text-2xl font-bold" id="completedPatients">0</h3>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 text-purple-600 mr-4">
                        <i class="fas fa-user-md text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Doctors Available</p>
                        <h3 class="text-2xl font-bold">4</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Queue Management -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Queue Management</h2>
                <div class="flex items-center">
                    <div class="relative mr-3">
                        <input type="text" id="searchInput" placeholder="Search patients..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                    <select id="statusFilter" class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">All Status</option>
                        <option value="Waiting">Waiting</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="py-3 px-4 border-b font-semibold text-left">Token</th>
                            <th class="py-3 px-4 border-b font-semibold text-left">Patient Name</th>
                            <th class="py-3 px-4 border-b font-semibold text-left">Mobile</th>
                            <th class="py-3 px-4 border-b font-semibold text-left">Doctor</th>
                            <th class="py-3 px-4 border-b font-semibold text-left">Appointment Date</th>
                            <th class="py-3 px-4 border-b font-semibold text-left">Status</th>
                            <th class="py-3 px-4 border-b font-semibold text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="queueTableBody">
                        <!-- Queue data will be inserted here -->
                    </tbody>
                </table>
            </div>
            
            <div class="mt-6 text-center text-gray-500 hidden" id="emptyState">
                <i class="fas fa-users-slash text-4xl mb-3"></i>
                <p>No patients in the queue</p>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white p-6 mt-10">
        <div class="container mx-auto text-center">
            <p>&copy; 2025 MediQueue Admin Panel. All rights reserved.</p>
        </div>
    </footer>

    <script>
    // DOM Elements
    const queueTableBody = document.getElementById('queueTableBody');
    const totalPatients = document.getElementById('totalPatients');
    const waitingPatients = document.getElementById('waitingPatients');
    const completedPatients = document.getElementById('completedPatients');
    const emptyState = document.getElementById('emptyState');
    const refreshBtn = document.getElementById('refreshBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const adminUsername = document.getElementById('adminUsername');
    const filterDate = document.getElementById('filterDate');
    const todayBtn = document.getElementById('todayBtn');
    const resetFilterBtn = document.getElementById('resetFilterBtn');

    // Set today's date as default for filter
    const today = new Date();
    const todayFormatted = today.toISOString().split('T')[0];
    filterDate.value = todayFormatted;

    // State variables
    let allQueueData = [];
    let filteredQueueData = [];
    let currentFilterDate = todayFormatted;

    // Event Listeners
    refreshBtn.addEventListener('click', loadQueueData);
    logoutBtn.addEventListener('click', handleLogout);
    searchInput.addEventListener('input', applyFilters);
    statusFilter.addEventListener('change', applyFilters);
    filterDate.addEventListener('change', handleDateFilter);
    todayBtn.addEventListener('click', handleTodayClick);
    resetFilterBtn.addEventListener('click', handleResetFilter);

    // Load initial data
    loadQueueData();

    // Check authentication on page load
    async function checkAuthentication() {
        try {
            const response = await fetch('/api/auth-status');
            const data = await response.json();
            
            if (data.isAuthenticated) {
                // Set username in header
                adminUsername.textContent = data.username;
                return true;
            } else {
                console.log('Not authenticated, redirecting to login');
                // Redirect to login
                window.location.href = '/login';
                return false;
            }
        } catch (error) {
            console.error('Auth check error:', error);
            // Redirect to login on error
            window.location.href = '/login';
            return false;
        }
    }

    // Logout functionality
    async function handleLogout() {
        try {
            // Call logout API
            await fetch('/api/admin-logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
        } catch (error) {
            console.error('Logout API error:', error);
        }
        
        // Redirect to login
        window.location.href = '/login';
    }

    // Handle date filter change
    function handleDateFilter() {
        currentFilterDate = filterDate.value;
        applyFilters();
    }

    // Handle today button click
    function handleTodayClick() {
        filterDate.value = todayFormatted;
        currentFilterDate = todayFormatted;
        applyFilters();
    }

    // Handle reset filter
    function handleResetFilter() {
        filterDate.value = todayFormatted;
        currentFilterDate = todayFormatted;
        searchInput.value = '';
        statusFilter.value = 'all';
        applyFilters();
    }

    // Apply all filters
    function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusValue = statusFilter.value;
        
        // Filter by date first
        let filteredByDate = allQueueData;
        if (currentFilterDate) {
            filteredByDate = allQueueData.filter(patient => {
                const appointmentDate = new Date(patient.appointmentDate).toISOString().split('T')[0];
                return appointmentDate === currentFilterDate;
            });
        }
        
        // Then apply search and status filters
        filteredQueueData = filteredByDate.filter(patient => {
            const matchesSearch = patient.patientName.toLowerCase().includes(searchTerm) ||
                                patient.token.toLowerCase().includes(searchTerm) ||
                                patient.mobileNumber.includes(searchTerm);
            
            const matchesStatus = statusValue === 'all' || patient.status === statusValue;
            
            return matchesSearch && matchesStatus;
        });
        
        renderQueueTable(filteredQueueData);
        updateStats(filteredQueueData);
    }

    // Update statistics
    function updateStats(queue) {
        totalPatients.textContent = queue.length;
        waitingPatients.textContent = queue.filter(p => p.status === 'Waiting').length;
        completedPatients.textContent = queue.filter(p => p.status === 'Completed').length;
    }

    // Show notification
    function showNotification(message, type = 'success') {
        // Remove any existing notifications
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) {
            existingNotification.remove();
        }
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Show notification
        setTimeout(() => {
            notification.classList.add('show');
        }, 10);
        
        // Remove notification after 3 seconds
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    // Load queue data for admin panel
    async function loadQueueData() {
        try {
            const response = await fetch('/api/queue', {
                headers: {
                    'X-Session-Token': getCookie('sessionToken') || ''
                }
            });
            
            if (response.status === 401) {
                // Unauthorized - redirect to login
                console.log('Queue access unauthorized, redirecting to login');
                window.location.href = '/login';
                return;
            }
            
            if (!response.ok) {
                throw new Error('Failed to fetch queue data');
            }
            
            const data = await response.json();
            allQueueData = data.queue || [];
            
            // Apply current filters
            applyFilters();
        } catch (error) {
            console.error('Error loading queue data:', error);
            queueTableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="py-4 px-4 text-center border-b text-red-500">
                        <i class="fas fa-exclamation-circle mr-2"></i>Error loading queue data
                    </td>
                </tr>
            `;
            showNotification('Failed to load queue data', 'error');
        }
    }

    // Helper function to get cookie value
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // Render queue table
    function renderQueueTable(queue) {
        // Show/hide empty state
        if (queue.length === 0) {
            emptyState.classList.remove('hidden');
            queueTableBody.innerHTML = '';
            return;
        } else {
            emptyState.classList.add('hidden');
        }
        
        // Clear table body
        queueTableBody.innerHTML = '';
        
        // Sort by appointment date and then by token number
        const sortedQueue = [...queue].sort((a, b) => {
            // First by appointment date
            const dateA = new Date(a.appointmentDate);
            const dateB = new Date(b.appointmentDate);
            
            if (dateA < dateB) return -1;
            if (dateA > dateB) return 1;
            
            // If same date, sort by token number
            const aNum = parseInt(a.token.split('-')[1]);
            const bNum = parseInt(b.token.split('-')[1]);
            return aNum - bNum;
        });
        
        // Add patients to table
        sortedQueue.forEach(patient => {
            const row = document.createElement('tr');
            row.className = `hover:bg-gray-50 ${patient.status === 'Completed' ? 'queue-item-completed' : ''}`;
            
            // Format appointment date
            const appointmentDate = new Date(patient.appointmentDate);
            const formattedDate = appointmentDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            // Check if this is today's first waiting patient
            const isFirstWaiting = patient.status === 'Waiting' && 
                sortedQueue.filter(p => p.status === 'Waiting' && 
                new Date(p.appointmentDate).toDateString() === appointmentDate.toDateString())[0] === patient;
            
            if (isFirstWaiting) {
                row.classList.add('token-highlight');
            }
            
            row.innerHTML = `
                <td class="py-3 px-4 border-b font-mono">${patient.token}</td>
                <td class="py-3 px-4 border-b">${patient.patientName}</td>
                <td class="py-3 px-4 border-b">${patient.mobileNumber}</td>
                <td class="py-3 px-4 border-b">${getDoctorName(patient.doctorId)}</td>
                <td class="py-3 px-4 border-b">${formattedDate}</td>
                <td class="py-3 px-4 border-b">
                    <span class="badge badge-${patient.status.toLowerCase()}">
                        <i class="fas ${patient.status === 'Waiting' ? 'fa-clock' : 'fa-check-circle'} mr-1"></i>
                        ${patient.status}
                    </span>
                </td>
                <td class="py-3 px-4 border-b">
                    ${patient.status === 'Waiting' ? 
                        `<button onclick="completePatient('${patient.token}')" class="bg-green-500 text-white px-3 py-1 rounded-md hover:bg-green-600 transition duration-300 mr-2">
                            <i class="fas fa-check-circle mr-1"></i> Complete
                        </button>` : 
                        ''
                    }
                    <button onclick="removePatient('${patient.token}')" class="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 transition duration-300">
                        <i class="fas fa-times-circle mr-1"></i> Remove
                    </button>
                </td>
            `;
            queueTableBody.appendChild(row);
        });
    }

    // Helper function to get doctor name from ID
    function getDoctorName(doctorId) {
        const doctors = {
            '1': 'Dr. Sarah - Cardiology',
            '2': 'Dr. Michael - Orthopedics',
            '3': 'Dr. Emily - Pediatrics',
            '4': 'Dr. Robert - Neurology'
        };
        return doctors[doctorId] || 'Unknown Doctor';
    }

    // Complete patient
    async function completePatient(token) {
        try {
            const response = await fetch('/api/complete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Session-Token': getCookie('sessionToken') || ''
                },
                body: JSON.stringify({ token })
            });
            
            if (response.status === 401) {
                // Unauthorized - redirect to login
                window.location.href = '/login';
                return;
            }
            
            if (!response.ok) {
                throw new Error('Failed to complete appointment');
            }
            
            await loadQueueData();
            showNotification(`Patient with token ${token} marked as completed`);
        } catch (error) {
            console.error('Error completing appointment:', error);
            showNotification('Failed to complete appointment', 'error');
        }
    }

    // Remove patient
    async function removePatient(token) {
        if (!confirm('Are you sure you want to remove this patient from the queue?')) {
            return;
        }
        
        try {
            const response = await fetch('/api/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Session-Token': getCookie('sessionToken') || ''
                },
                body: JSON.stringify({ token })
            });
            
            if (response.status === 401) {
                // Unauthorized - redirect to login
                window.location.href = '/login';
                return;
            }
            
            if (!response.ok) {
                throw new Error('Failed to remove appointment');
            }
            
            await loadQueueData();
            showNotification(`Patient with token ${token} removed from queue`);
        } catch (error) {
            console.error('Error removing appointment:', error);
            showNotification('Failed to remove appointment', 'error');
        }
    }

    // Auto-refresh queue every 10 seconds
    setInterval(loadQueueData, 10000);
    </script>
</body>
</html>